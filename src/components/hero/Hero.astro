---
import { hero, author } from '@/config.json'
import { SocialList } from './SocialList'
import Highlight from '@/components/Highlight.astro'
import fs from 'fs/promises'; // Node.js æ–‡ä»¶ç³»ç»Ÿæ¨¡å—

// é»˜è®¤çš„ä¸€è¨€å†…å®¹
let yiyan = "å·§ç¬‘å€©å…®ï¼Œç¾ç›®ç›¼å…®";
let yiyanAuthor = "ivan";

// å®šä¹‰æœ¬åœ°å­˜å‚¨è·¯å¾„
const yiyanCachePath = './src/components/hero/yiyan.json';

// å°è¯•ä» API è·å–ä¸€è¨€
try {
  const response = await fetch('https://v1.hitokoto.cn/');
  if (response.ok) {
    const data = await response.json();
    yiyan = data.hitokoto || yiyan;
    yiyanAuthor = data.from || yiyanAuthor;
    
    // å°†æ–°çš„ yiyan å’Œä½œè€…ä¿¡æ¯ä¿å­˜åˆ°æœ¬åœ°æ–‡ä»¶ä¸­
    await fs.writeFile(yiyanCachePath, JSON.stringify({ yiyan, yiyanAuthor }), 'utf-8');
  } else {
    console.error(`ä¸€è¨€ API è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.status}`);
    
    // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°æ–‡ä»¶è¯»å–ç¼“å­˜
    try {
      const cachedData = await fs.readFile(yiyanCachePath, 'utf-8');
      const cachedYiyan = JSON.parse(cachedData).yiyan;
      const cachedYiyanAuthor = JSON.parse(cachedData).yiyanAuthor;
      yiyan = cachedYiyan || yiyan;
      yiyanAuthor = cachedYiyanAuthor || yiyanAuthor;
    } catch (readError) {
      console.error('è¯»å–æœ¬åœ°ç¼“å­˜æ—¶å‘ç”Ÿé”™è¯¯:', readError);
    }
  }
} catch (error) {
  console.error('è·å–ä¸€è¨€æ—¶å‘ç”Ÿé”™è¯¯:', error);

  // å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œå°è¯•ä»æœ¬åœ°æ–‡ä»¶è¯»å–ç¼“å­˜
  try {
    const cachedData = await fs.readFile(yiyanCachePath, 'utf-8');
    const cachedYiyan = JSON.parse(cachedData).yiyan;
    const cachedYiyanAuthor = JSON.parse(cachedData).yiyanAuthor;
    yiyan = cachedYiyan || yiyan;
    yiyanAuthor = cachedYiyanAuthor || yiyanAuthor;
  } catch (readError) {
    console.error('è¯»å–æœ¬åœ°ç¼“å­˜æ—¶å‘ç”Ÿé”™è¯¯:', readError);
  }
}

// å°†ä¸€è¨€å’Œä½œè€…ä¿¡æ¯æ·»åŠ åˆ° hero å¯¹è±¡ä¸­
hero.yiyan = `${yiyan} -- ${yiyanAuthor}`;
---

<div class="lg:-mt-16 lg:h-dvh lg:min-h-[720px]">
  <div
    class="relative max-w-[1300px] mx-auto h-full px-4 grid lg:grid-cols-2 items-center justify-items-center"
  >
    <div class="mt-[120px] lg:mt-0 max-w-[590px]">
      <h1 class="text-3xl text-center lg:text-left text-balance">
        Hi there, I'm <Highlight class="font-bold">{hero.name}</Highlight>ğŸ‘‹<br />{hero.bio}
      </h1>
      <div class="text-sm text-secondary mt-3 text-center lg:text-left">{hero.description}</div>
      <SocialList className="mt-[60px]" client:load />
    </div>
    <div class="mt-20 lg:mt-0">
      <div
        class="size-[200px] lg:size-[300px] rounded-full overflow-hidden border border-primary bg-zinc-100 dark:bg-zinc-800"
      >
        <img class="size-full" src={author.avatar} alt="Site owner avatar" loading="lazy" />
      </div>
    </div>

    <div class="mt-10 lg:mt-0 lg:absolute inset-x-0 bottom-0 flex flex-col items-center">
      <p class="text-xs text-center text-balance text-secondary">
        {hero.yiyan}
      </p>
      <div class="mt-7 text-xl animate-bounce">
        <i class="iconfont icon-down"></i>
      </div>
    </div>
  </div>
</div>
